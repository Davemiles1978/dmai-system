<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>DMAI - EVOLUTIONARY AI PLATFORM</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        
        :root {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #eef2f6;
            --text-primary: #2d3e50;
            --text-secondary: #6c7a8a;
            --accent: #3498db;
            --accent-light: #5faee3;
            --border: #dce4ec;
            --message-user: #3498db;
            --message-user-text: white;
            --message-ai: #ffffff;
            --message-ai-text: #2d3e50;
            --shadow: rgba(0,0,0,0.05);
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #3498db;
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #1e2a3a;
                --bg-secondary: #2c3e50;
                --bg-tertiary: #34495e;
                --text-primary: #ecf0f1;
                --text-secondary: #bdc3c7;
                --accent: #3498db;
                --accent-light: #5faee3;
                --border: #4a6782;
                --message-user: #3498db;
                --message-user-text: white;
                --message-ai: #34495e;
                --message-ai-text: #ecf0f1;
                --shadow: rgba(0,0,0,0.2);
            }
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }
        
        /* Mobile Responsive Fix */
        @media (max-width: 768px) {
            #app {
                grid-template-columns: 1fr !important;
                grid-template-rows: 60px 1fr 80px !important;
                overflow-y: auto;
            }
            
            .chat-list-panel, .tools-panel {
                display: none;
                position: fixed;
                top: 60px;
                left: 0;
                width: 100%;
                height: calc(100% - 140px);
                z-index: 1000;
                background: var(--bg-secondary);
                overflow-y: auto;
            }
            
            .chat-list-panel.active, .tools-panel.active {
                display: block;
            }
            
            .messages-container {
                height: calc(100vh - 140px);
                overflow-y: auto;
                padding-bottom: 20px;
            }
            
            .message {
                max-width: 95%;
            }
            
            .mobile-menu-bar {
                display: flex !important;
                position: fixed;
                bottom: 80px;
                left: 0;
                width: 100%;
                background: var(--bg-secondary);
                border-top: 1px solid var(--border);
                padding: 10px;
                z-index: 100;
            }
            
            .mobile-menu-btn {
                flex: 1;
                padding: 12px;
                background: var(--bg-tertiary);
                border: 1px solid var(--border);
                color: var(--text-primary);
                border-radius: 8px;
                margin: 0 5px;
                font-size: 14px;
                cursor: pointer;
            }
            
            .mobile-menu-btn:hover {
                border-color: var(--accent);
                color: var(--accent);
            }
        }
        
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .login-container {
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px var(--shadow);
            width: 400px;
            max-width: 90%;
        }
        
        .login-container h1 {
            color: var(--accent);
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .login-container h3 {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-weight: normal;
        }
        
        .login-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .login-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1em;
            border-bottom: 2px solid transparent;
        }
        
        .login-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        
        .login-form {
            display: block;
        }
        
        .login-form.hidden {
            display: none;
        }
        
        .login-container input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 6px;
            font-size: 1em;
        }
        
        .login-container button {
            width: 100%;
            padding: 12px;
            margin: 20px 0;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            cursor: pointer;
        }
        
        .login-error {
            color: var(--danger);
            text-align: center;
            margin: 10px 0;
        }
        
        #main-app {
            display: none;
            height: 100vh;
            overflow: hidden;
        }
        
        #app {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            grid-template-rows: 60px 1fr 80px;
            height: 100vh;
        }
        
        .header {
            grid-column: 1 / -1;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 10;
        }
        
        .logo {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .evolution-badge {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-left: 15px;
            border: 1px solid var(--border);
        }
        
        .evolution-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 5px;
            background-color: var(--success);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .header-right {
            margin-left: auto;
        }
        
        .user-menu {
            position: relative;
        }
        
        .user-menu-trigger {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
        }
        
        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 45px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            min-width: 200px;
            box-shadow: 0 5px 20px var(--shadow);
            z-index: 1000;
        }
        
        .user-menu:hover .dropdown-content,
        .dropdown-content:hover {
            display: block;
        }
        
        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover {
            background: var(--bg-tertiary);
        }
        
        .dropdown-item.admin {
            border-left: 3px solid var(--warning);
        }
        
        .chat-list-panel {
            grid-column: 1;
            grid-row: 2 / 4;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            padding: 20px;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        
        .panel-title {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        
        .new-chat-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .chat-item {
            position: relative;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        
        .chat-item:hover {
            border-color: var(--accent);
            background: color-mix(in srgb, var(--accent) 15%, var(--bg-tertiary));
        }
        
        .chat-item.active {
            border-color: var(--accent);
            background: color-mix(in srgb, var(--accent) 20%, var(--bg-tertiary));
        }
        
        .chat-name {
            font-weight: 500;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }
        
        .chat-meta {
            font-size: 0.8em;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }
        
        .chat-date {
            font-size: 0.7em;
            color: var(--text-secondary);
        }
        
        .chat-preview {
            font-size: 0.75em;
            color: var(--text-secondary);
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .main-chat-panel {
            grid-column: 2;
            grid-row: 2 / 3;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-right: 1px solid var(--border);
        }
        
        .chat-header {
            padding: 15px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .chat-header h2 {
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .evolution-ticker {
            font-size: 0.8em;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            padding: 4px 10px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.5;
            word-wrap: break-word;
        }
        
        .message.user {
            align-self: flex-end;
            background: var(--message-user);
            color: var(--message-user-text);
        }
        
        .message.ai {
            align-self: flex-start;
            background: var(--message-ai);
            color: var(--message-ai-text);
            border: 1px solid var(--border);
        }
        
        .message-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            font-size: 0.7em;
            color: var(--text-secondary);
        }
        
        .continue-thread-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 2px 8px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .continue-thread-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .tools-panel {
            grid-column: 3;
            grid-row: 2 / 4;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            overflow-y: auto;
            padding: 20px;
        }
        
        .tools-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .tools-title {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 15px;
            text-transform: uppercase;
        }
        
        .tool-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .tool-btn {
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 0.85em;
        }
        
        .tool-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .tool-btn.wide {
            grid-column: span 2;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .action-btn {
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            text-align: left;
            font-size: 0.9em;
        }
        
        .action-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .action-btn.danger:hover {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .suggestion-box textarea {
            width: 100%;
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 6px;
            min-height: 60px;
            margin-bottom: 10px;
            resize: vertical;
        }
        
        .suggestion-btn {
            width: 100%;
            padding: 10px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .info-box {
            background: var(--bg-tertiary);
            border-radius: 6px;
            padding: 12px;
            margin-top: 20px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            padding: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
        }
        
        .copy-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .url-display {
            color: var(--accent);
            font-family: monospace;
            font-size: 0.8em;
            word-break: break-all;
        }
        
        .style-preset {
            display: inline-block;
            padding: 4px 10px;
            margin: 3px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .style-preset:hover {
            border-color: var(--accent);
            background: color-mix(in srgb, var(--accent) 10%, var(--bg-tertiary));
        }
        
        .platform-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            background: var(--bg-tertiary);
            border-radius: 20px;
            margin: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .platform-badge:hover {
            border: 1px solid var(--accent);
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .status-connected {
            background-color: #2ecc71;
            box-shadow: 0 0 5px #2ecc71;
        }
        
        .status-disconnected {
            background-color: #e74c3c;
        }
        
        .input-area {
            grid-column: 2;
            grid-row: 3;
            padding: 15px 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
        }
        
        .input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        textarea {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            color: var(--text-primary);
            font-family: inherit;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            font-size: 0.95em;
        }
        
        .send-btn {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            width: 60px;
            height: 50px;
            cursor: pointer;
            font-size: 1.2em;
        }
        
        /* Mobile Menu Bar - Hidden by default on desktop */
        .mobile-menu-bar {
            display: none;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        
        .chat-context-menu {
            animation: menuFadeIn 0.1s ease;
            z-index: 10000;
        }
        
        @keyframes menuFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .archive-modal-btn {
            transition: opacity 0.2s;
        }
        
        .archive-modal-btn:hover {
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-container">
            <h1>üß¨ DMAI</h1>
            <h3>Evolutionary AI Platform</h3>
            
            <div class="login-tabs">
                <button class="login-tab active" onclick="switchLoginTab('login')">Sign In</button>
                <button class="login-tab" onclick="switchLoginTab('register')">Register</button>
            </div>
            
            <div id="login-form" class="login-form">
                <input type="text" id="login-username" placeholder="Username">
                <input type="password" id="login-password" placeholder="Password">
                <div class="login-error" id="login-error"></div>
                <button onclick="login()">Sign In</button>
            </div>
            
            <div id="register-form" class="login-form hidden">
                <input type="text" id="reg-username" placeholder="Username">
                <input type="password" id="reg-password" placeholder="Password">
                <input type="password" id="reg-confirm" placeholder="Confirm Password">
                <div class="login-error" id="register-error"></div>
                <button onclick="register()">Create Account</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app">
        <div id="app">
            <!-- Header -->
            <div class="header">
                <div class="logo">
                    <span>üß¨</span>
                    <span>DMAI</span>
                    <span class="evolution-badge" id="version-badge">
                        Gen <span id="gen-display">?</span>
                        <span class="evolution-status" id="evolution-status-dot"></span>
                    </span>
                </div>
                <div class="header-right">
                    <div class="user-menu">
                        <div class="user-menu-trigger">
                            <div class="avatar" id="user-avatar">DM</div>
                            <span id="current-user">david</span>
                            <span>‚ñº</span>
                        </div>
                        <div class="dropdown-content">
                            <div class="dropdown-item" onclick="showProfile()">üë§ Profile</div>
                            <div class="dropdown-item" onclick="openSettings()">‚öôÔ∏è Settings</div>
                            <div class="dropdown-item" onclick="showSuggestions()">üí° Suggest</div>
                            <div class="dropdown-item" onclick="changePassword()">üîë Password</div>
                            <div class="dropdown-item admin" id="admin-menu" style="display:none;" onclick="openAdminPanel()">üëë Admin</div>
                            <div class="dropdown-item" onclick="logout()">üö™ Logout</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- LEFT COLUMN - Chat List -->
            <div class="chat-list-panel">
                <div class="panel-header">
                    <span class="panel-title">üìÅ CHATS</span>
                    <button class="new-chat-btn" onclick="newChat()">+ New</button>
                </div>
                <div id="chat-list"></div>
                <div style="margin-top: 20px;">
                    <button class="action-btn" style="width:100%;" onclick="showArchivedChats()">üì¶ View Archive</button>
                </div>
            </div>
            
            <!-- CENTER COLUMN - Main Chat -->
            <div class="main-chat-panel">
                <div class="chat-header">
                    <h2 id="current-chat">Current Chat</h2>
                    <div class="evolution-ticker">
                        <span>‚è≥ Evolution Cycle</span>
                        <span id="cycle-ticker">‚îÄ</span>
                    </div>
                </div>
                <div class="messages-container" id="messages"></div>
            </div>
            
            <!-- RIGHT COLUMN - Tools Panel -->
            <div class="tools-panel" id="tools-panel"></div>
            
            <!-- Input Area -->
            <div class="input-area">
                <div class="input-container">
                    <textarea id="message-input" placeholder="Ask me anything... Your conversations guide evolution."></textarea>
                    <button class="send-btn" onclick="sendMessage()">‚û§</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mobile Menu Bar -->
    <div class="mobile-menu-bar">
        <button class="mobile-menu-btn" onclick="toggleMobilePanel('chats')">üìÅ Chats</button>
        <button class="mobile-menu-btn" onclick="toggleMobilePanel('tools')">üõ†Ô∏è Tools</button>
    </div>

    <script>
        // Mobile panel toggle
        function toggleMobilePanel(panel) {
            const chatPanel = document.querySelector('.chat-list-panel');
            const toolsPanel = document.querySelector('.tools-panel');
            
            if (panel === 'chats') {
                chatPanel.classList.toggle('active');
                toolsPanel.classList.remove('active');
            } else {
                toolsPanel.classList.toggle('active');
                chatPanel.classList.remove('active');
            }
        }

        // ==================== REAL EVOLUTION DATA FETCHING ====================
        let evolutionData = {
            generation: 1,
            bestScore: 0,
            nextCycleIn: 3600,
            status: 'running'
        };
        
        async function fetchEvolutionStats() {
            try {
                const response = await fetch('/api/evolution-stats');
                if (response.ok) {
                    const data = await response.json();
                    evolutionData.generation = data.generation || evolutionData.generation;
                    evolutionData.bestScore = data.bestScore || evolutionData.bestScore;
                    evolutionData.status = data.status || 'running';
                    
                    updateGenerationDisplay();
                    
                    const dot = document.getElementById('evolution-status-dot');
                    if (dot) {
                        dot.style.backgroundColor = evolutionData.status === 'running' ? 'var(--success)' : 'var(--warning)';
                    }
                }
            } catch (error) {
                console.log('Evolution API not available');
                if (!evolutionData.generation || evolutionData.generation === 1) {
                    evolutionData.generation = 266;
                    updateGenerationDisplay();
                }
            }
        }
        
        async function submitGuidanceToEngine(guidance) {
            try {
                const response = await fetch('/api/submit-guidance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ guidance: guidance })
                });
                if (response.ok) {
                    showNotification('üí° Guidance sent to evolution engine');
                }
            } catch (error) {
                console.log('Guidance API not available');
            }
        }
        
        function updateGenerationDisplay() {
            const displays = ['gen-display'];
            displays.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    let displayGen = evolutionData.generation;
                    if (displayGen >= 10000) {
                        displayGen = (displayGen/1000).toFixed(1) + 'k';
                    } else if (displayGen >= 1000) {
                        displayGen = (displayGen/1000).toFixed(1) + 'k';
                    }
                    el.textContent = displayGen;
                }
            });
            
            const ticker = document.getElementById('cycle-ticker');
            if (ticker) {
                const nextIn = Math.floor(evolutionData.nextCycleIn / 60);
                ticker.textContent = `Next cycle in ${nextIn}m`;
            }
        }
        
        setInterval(fetchEvolutionStats, 30000);
        
        // ==================== USER DATABASE ====================
        let users = {
            'david': { password: 'dmai2026', role: 'admin', email: '', apiKeys: {} }
        };
        
        let currentUser = null;
        let currentUserRole = 'user';
        let internetEnabled = false;
        let projects = [];
        let currentChat = null;
        let activeContextMenu = null;
        
        const videoStyles = {
            manga: { name: 'Manga/Anime', description: 'Japanese animation style, cel-shaded, expressive', parameters: { fps: 24, resolution: '1080p', style_strength: 0.9 } },
            photorealistic: { name: 'Photorealistic', description: 'Cinematic quality, natural lighting, realistic textures', parameters: { fps: 30, resolution: '4K', style_strength: 0.95 } },
            watercolor: { name: 'Watercolor', description: 'Soft, artistic, flowing paint effect', parameters: { fps: 24, resolution: '1080p', style_strength: 0.85 } },
            cyberpunk: { name: 'Cyberpunk', description: 'Neon lights, futuristic, high contrast', parameters: { fps: 30, resolution: '4K', style_strength: 0.9 } },
            claymation: { name: 'Claymation', description: 'Stop-motion style, clay-like textures', parameters: { fps: 15, resolution: '1080p', style_strength: 0.8 } },
            oil_painting: { name: 'Oil Painting', description: 'Classical painting style, visible brushstrokes', parameters: { fps: 24, resolution: '1080p', style_strength: 0.9 } }
        };

        const socialPlatforms = {
            youtube: { name: 'YouTube', icon: 'üì∫', videoFormats: ['MP4', 'MOV'], maxDuration: 43200, aspectRatios: ['16:9'] },
            instagram: { name: 'Instagram', icon: 'üì∑', videoFormats: ['MP4'], maxDuration: 60, aspectRatios: ['1:1', '9:16', '16:9'] },
            tiktok: { name: 'TikTok', icon: 'üéµ', videoFormats: ['MP4'], maxDuration: 180, aspectRatios: ['9:16'] },
            twitter: { name: 'Twitter/X', icon: 'üê¶', videoFormats: ['MP4'], maxDuration: 140, aspectRatios: ['16:9', '1:1'] },
            facebook: { name: 'Facebook', icon: 'üë§', videoFormats: ['MP4', 'MOV'], maxDuration: 14400, aspectRatios: ['16:9', '1:1'] }
        };

        let socialAccounts = {
            youtube: { connected: false, channelName: '' },
            instagram: { connected: false, username: '' },
            tiktok: { connected: false, username: '' },
            twitter: { connected: false, handle: '' },
            facebook: { connected: false, pageName: '' }
        };

        // ==================== UTILITY FUNCTIONS ====================
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.right = '20px';
            notification.style.background = 'var(--accent)';
            notification.style.color = 'white';
            notification.style.padding = '10px 20px';
            notification.style.borderRadius = '8px';
            notification.style.boxShadow = '0 5px 20px var(--shadow)';
            notification.style.zIndex = '10001';
            notification.style.animation = 'fadeInOut 2s ease';
            
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 2000);
        }

        function loadUsers() {
            const saved = localStorage.getItem('dmai_users');
            if (saved) {
                try {
                    users = JSON.parse(saved);
                } catch (e) {}
            }
            if (!users['david']) {
                users['david'] = { password: 'dmai2026', role: 'admin', email: '', apiKeys: {} };
            }
            saveUsers();
        }
        
        function saveUsers() {
            localStorage.setItem('dmai_users', JSON.stringify(users));
        }
        
        // ==================== LOGIN FUNCTIONS ====================
        function switchLoginTab(tab) {
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.login-form').forEach(f => f.classList.add('hidden'));
            
            if (tab === 'login') {
                document.querySelector('.login-tab').classList.add('active');
                document.getElementById('login-form').classList.remove('hidden');
            } else {
                document.querySelectorAll('.login-tab')[1].classList.add('active');
                document.getElementById('register-form').classList.remove('hidden');
            }
        }
        
        // Auto-login if previously logged in
        function checkAutoLogin() {
            const loggedIn = localStorage.getItem('dmai_logged_in');
            if (loggedIn === 'true') {
                const savedUser = localStorage.getItem('dmai_username');
                const savedRole = localStorage.getItem('dmai_role');
                if (savedUser && users[savedUser]) {
                    currentUser = savedUser;
                    currentUserRole = savedRole || users[savedUser].role;
                    
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-app').style.display = 'block';
                    document.getElementById('current-user').textContent = savedUser;
                    document.getElementById('user-avatar').textContent = savedUser.substring(0,2).toUpperCase();
                    
                    if (currentUserRole === 'admin') {
                        document.getElementById('admin-menu').style.display = 'block';
                    }
                    
                    loadData();
                    initializeToolsPanel();
                    fetchEvolutionStats();
                    return true;
                }
            }
            return false;
        }
        
        function login() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            
            if (users[username] && users[username].password === password) {
                currentUser = username;
                currentUserRole = users[username].role;
                
                // Save login state
                localStorage.setItem('dmai_logged_in', 'true');
                localStorage.setItem('dmai_username', username);
                localStorage.setItem('dmai_role', currentUserRole);
                
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                document.getElementById('current-user').textContent = username;
                document.getElementById('user-avatar').textContent = username.substring(0,2).toUpperCase();
                
                if (currentUserRole === 'admin') {
                    document.getElementById('admin-menu').style.display = 'block';
                }
                
                loadData();
                initializeToolsPanel();
                fetchEvolutionStats();
            } else {
                document.getElementById('login-error').textContent = 'Invalid credentials';
            }
        }
        
        function register() {
            const username = document.getElementById('reg-username').value.trim();
            const password = document.getElementById('reg-password').value;
            const confirm = document.getElementById('reg-confirm').value;
            
            if (!username || !password) {
                document.getElementById('register-error').textContent = 'All fields required';
                return;
            }
            if (password !== confirm) {
                document.getElementById('register-error').textContent = 'Passwords do not match';
                return;
            }
            if (users[username]) {
                document.getElementById('register-error').textContent = 'Username exists';
                return;
            }
            
            users[username] = { password: password, role: 'user', email: '', apiKeys: {} };
            saveUsers();
            
            currentUser = username;
            currentUserRole = 'user';
            
            // Save login state
            localStorage.setItem('dmai_logged_in', 'true');
            localStorage.setItem('dmai_username', username);
            localStorage.setItem('dmai_role', currentUserRole);
            
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('current-user').textContent = username;
            document.getElementById('user-avatar').textContent = username.substring(0,2).toUpperCase();
            
            loadData();
            initializeToolsPanel();
            fetchEvolutionStats();
        }
        
        function logout() {
            localStorage.removeItem('dmai_logged_in');
            localStorage.removeItem('dmai_username');
            localStorage.removeItem('dmai_role');
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-app').style.display = 'none';
        }
        
        function showProfile() {
            alert(`üë§ User: ${currentUser}\nRole: ${currentUserRole}\nGeneration: ${evolutionData.generation}\nTotal chats: ${projects.length}`);
        }
        
        function openSettings() {
            const settingsModal = document.createElement('div');
            settingsModal.style.position = 'fixed';
            settingsModal.style.top = '0';
            settingsModal.style.left = '0';
            settingsModal.style.width = '100%';
            settingsModal.style.height = '100%';
            settingsModal.style.background = 'rgba(0,0,0,0.5)';
            settingsModal.style.zIndex = '10000';
            settingsModal.style.display = 'flex';
            settingsModal.style.alignItems = 'center';
            settingsModal.style.justifyContent = 'center';
            
            const modalContent = document.createElement('div');
            modalContent.style.background = 'var(--bg-secondary)';
            modalContent.style.borderRadius = '12px';
            modalContent.style.padding = '30px';
            modalContent.style.width = '500px';
            modalContent.style.maxWidth = '90%';
            modalContent.style.border = '1px solid var(--border)';
            
            modalContent.innerHTML = `
                <h2 style="color: var(--accent); margin-bottom: 20px;">‚öôÔ∏è Settings</h2>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">Theme</label>
                    <select id="theme-select" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); border-radius: 4px;">
                        <option value="auto">Auto (System)</option>
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">Font Size</label>
                    <select id="font-size" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); border-radius: 4px;">
                        <option value="small">Small</option>
                        <option value="medium" selected>Medium</option>
                        <option value="large">Large</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">Internet Mode</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button onclick="toggleInternet()" style="padding: 8px 15px; background: ${internetEnabled ? 'var(--success)' : 'var(--bg-tertiary)'}; color: ${internetEnabled ? 'white' : 'var(--text-primary)'}; border: none; border-radius: 4px; cursor: pointer;">
                            ${internetEnabled ? 'üåê Online' : 'üì° Offline'}
                        </button>
                        <span style="color: var(--text-secondary);">Current: ${internetEnabled ? 'Online' : 'Offline'}</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button onclick="saveSettings()" style="flex: 1; padding: 10px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer;">Save Settings</button>
                    <button onclick="document.body.removeChild(this.parentElement.parentElement.parentElement)" style="flex: 1; padding: 10px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">Cancel</button>
                </div>
            `;
            
            settingsModal.appendChild(modalContent);
            document.body.appendChild(settingsModal);
        }
        
        function saveSettings() {
            const theme = document.getElementById('theme-select')?.value;
            const fontSize = document.getElementById('font-size')?.value;
            
            if (theme) {
                if (theme === 'light') {
                    document.documentElement.style.setProperty('--bg-primary', '#f5f7fa');
                    document.documentElement.style.setProperty('--bg-secondary', '#ffffff');
                } else if (theme === 'dark') {
                    document.documentElement.style.setProperty('--bg-primary', '#1e2a3a');
                    document.documentElement.style.setProperty('--bg-secondary', '#2c3e50');
                }
            }
            
            if (fontSize) {
                const sizes = { small: '0.85em', medium: '1em', large: '1.15em' };
                document.body.style.fontSize = sizes[fontSize];
            }
            
            showNotification('‚úÖ Settings saved');
        }
        
        function showSuggestions() {
            document.getElementById('suggestion-input')?.focus();
        }
        
        function changePassword() {
            const newPass = prompt('Enter new password:');
            if (newPass && newPass.length >= 4) {
                users[currentUser].password = newPass;
                saveUsers();
                showNotification('‚úÖ Password updated');
            }
        }
        
        function openAdminPanel() {
            if (currentUserRole !== 'admin') return;
            
            const userList = Object.entries(users).map(([name, data]) => 
                `${name} (${data.role})`
            ).join('\n');
            
            alert(`üëë Admin Panel\n\nUsers:\n${userList}\n\nCurrent Generation: ${evolutionData.generation}`);
        }
        
        function toggleInternet() {
            internetEnabled = !internetEnabled;
            showNotification(`Internet ${internetEnabled ? 'ON' : 'OFF'}`);
            initializeToolsPanel();
        }
        
        // ==================== ADMIN KILL SWITCH ====================
        function emergencyPause() {
            if (currentUserRole !== 'admin') {
                alert('Admin only');
                return;
            }
            if (confirm('‚ö†Ô∏è PAUSE evolution? This can be resumed later.')) {
                fetch('/api/pause-evolution', { method: 'POST' })
                    .then(() => showNotification('‚è∏Ô∏è Evolution paused'))
                    .catch(() => showNotification('‚ö†Ô∏è API not available'));
            }
        }
        
        function emergencyKill() {
            if (currentUserRole !== 'admin') {
                alert('Admin only');
                return;
            }
            if (confirm('üö®‚ö†Ô∏èüö® THIS WILL STOP ALL EVOLUTION PERMANENTLY! Type "KILL" to confirm:')) {
                const confirmText = prompt('Type "KILL" to confirm:');
                if (confirmText === 'KILL') {
                    fetch('/api/kill-system', { method: 'POST' })
                        .then(() => {
                            showNotification('‚õî System killed - restart required');
                            setTimeout(logout, 3000);
                        })
                        .catch(() => showNotification('‚ö†Ô∏è API not available'));
                }
            }
        }
        
        // ==================== CHAT MANAGEMENT ====================
        function loadData() {
            const saved = localStorage.getItem(`chats_${currentUser}`);
            if (saved) {
                try {
                    projects = JSON.parse(saved);
                } catch (e) {}
            }
            
            if (!projects || projects.length === 0) {
                projects = [{
                    id: 'chat_' + Date.now(),
                    name: 'Chat 1',
                    messages: [{
                        id: 'welcome_' + Date.now(),
                        role: 'ai',
                        content: 'üëã Welcome to DMAI! I\'m connected to a 24/7 evolution engine. Every hour, my code improves automatically.',
                        timestamp: new Date().toISOString()
                    }],
                    archived: false,
                    pinned: false,
                    created: new Date().toISOString()
                }];
            }
            
            projects.sort((a, b) => {
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;
                return 0;
            });
            
            currentChat = projects[0].id;
            renderChatList();
            renderMessages();
        }
        
        function saveProjects() {
            localStorage.setItem(`chats_${currentUser}`, JSON.stringify(projects));
        }
        
        function renderChatList() {
            const list = document.getElementById('chat-list');
            if (!list) return;
            
            list.innerHTML = projects.filter(p => !p.archived).map(p => {
                let dateDisplay = '';
                try {
                    if (p.created) {
                        const date = new Date(p.created);
                        if (!isNaN(date.getTime())) {
                            dateDisplay = date.toLocaleDateString();
                        }
                    }
                } catch (e) {}
                
                return `
                    <div class="chat-item ${p.id === currentChat ? 'active' : ''}" 
                         onclick="switchChat('${p.id}')"
                         oncontextmenu="showChatContextMenu(event, '${p.id}', '${p.name}')">
                        <div class="chat-name">
                            ${p.name} ${p.pinned ? 'üìå' : ''}
                        </div>
                        <div class="chat-meta">
                            <span>${p.messages.length} msgs</span>
                            <span class="chat-date">${dateDisplay}</span>
                        </div>
                        <div class="chat-preview">${p.messages.length > 0 ? p.messages[p.messages.length-1].content.substring(0, 30) + '...' : 'New chat'}</div>
                    </div>
                `;
            }).join('');
        }
        
        function showChatContextMenu(event, chatId, chatName) {
            event.preventDefault();
            event.stopPropagation();
            
            if (activeContextMenu) {
                activeContextMenu.remove();
            }
            
            const menu = document.createElement('div');
            menu.className = 'chat-context-menu';
            menu.style.position = 'absolute';
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            menu.style.background = 'var(--bg-secondary)';
            menu.style.border = '1px solid var(--border)';
            menu.style.borderRadius = '8px';
            menu.style.minWidth = '180px';
            menu.style.boxShadow = '0 5px 20px var(--shadow)';
            menu.style.padding = '5px 0';
            
            const menuItems = [
                { label: '‚úèÔ∏è Rename', action: () => renameChat(chatId) },
                { label: 'üì¶ Archive', action: () => archiveChat(chatId) },
                { label: 'üì§ Extract to New', action: () => extractChat(chatId) },
                { label: 'üìã Export as JSON', action: () => exportChat(chatId) },
                { label: 'üìÑ Export as Text', action: () => exportChatAsText(chatId) },
                { label: '‚≠ê Pin/Unpin', action: () => pinChat(chatId) },
                { label: 'üìë Duplicate', action: () => duplicateChat(chatId) },
                { label: 'üìä View Stats', action: () => viewChatStats(chatId) },
                { label: 'üóëÔ∏è Delete', action: () => deleteChat(chatId), danger: true }
            ];
            
            menuItems.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.textContent = item.label;
                menuItem.style.padding = '8px 15px';
                menuItem.style.cursor = 'pointer';
                menuItem.style.color = item.danger ? 'var(--danger)' : 'var(--text-primary)';
                menuItem.style.borderBottom = '1px solid var(--border)';
                
                menuItem.onmouseover = () => { menuItem.style.background = 'var(--bg-tertiary)'; };
                menuItem.onmouseout = () => { menuItem.style.background = 'transparent'; };
                menuItem.onclick = (e) => {
                    e.stopPropagation();
                    item.action();
                    menu.remove();
                    activeContextMenu = null;
                };
                
                menu.appendChild(menuItem);
            });
            
            document.body.appendChild(menu);
            activeContextMenu = menu;
            
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        activeContextMenu = null;
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 100);
        }
        
        function switchChat(id) {
            currentChat = id;
            const chat = projects.find(p => p.id === id);
            if (chat) {
                document.getElementById('current-chat').textContent = chat.name;
                renderMessages();
                renderChatList();
            }
        }
        
        function newChat() {
            const id = 'chat_' + Date.now();
            projects.push({
                id: id,
                name: `Chat ${projects.length + 1}`,
                messages: [],
                archived: false,
                pinned: false,
                created: new Date().toISOString()
            });
            currentChat = id;
            document.getElementById('current-chat').textContent = `Chat ${projects.length}`;
            saveProjects();
            renderChatList();
            renderMessages();
            showNotification('‚úÖ New chat created');
        }
        
        function renameChat(chatId) {
            const chat = projects.find(p => p.id === (chatId || currentChat));
            if (!chat) return;
            const name = prompt('Enter new chat name:', chat.name);
            if (name && name.trim()) {
                chat.name = name.trim();
                if (chatId === currentChat) {
                    document.getElementById('current-chat').textContent = name;
                }
                saveProjects();
                renderChatList();
                showNotification('‚úèÔ∏è Chat renamed');
            }
        }
        
        function archiveChat(chatId) {
            const chat = projects.find(p => p.id === chatId);
            if (chat) {
                chat.archived = true;
                saveProjects();
                renderChatList();
                if (currentChat === chatId) {
                    const firstUnarchived = projects.find(p => !p.archived);
                    if (firstUnarchived) {
                        currentChat = firstUnarchived.id;
                        document.getElementById('current-chat').textContent = firstUnarchived.name;
                        renderMessages();
                    }
                }
                showNotification('üì¶ Chat archived');
            }
        }
        
        function extractChat(chatId) {
            const chat = projects.find(p => p.id === chatId);
            if (!chat) return;
            
            const newId = 'chat_' + Date.now();
            const newChat = {
                id: newId,
                name: chat.name + ' (extracted)',
                messages: [...chat.messages.map(m => ({...m, id: 'copy_' + Date.now() + '_' + Math.random() }))],
                archived: false,
                pinned: false,
                created: new Date().toISOString(),
                extractedFrom: chatId
            };
            
            projects.push(newChat);
            saveProjects();
            renderChatList();
            showNotification('üì§ Chat extracted');
        }
        
        function exportChat(chatId) {
            const chat = projects.find(p => p.id === chatId);
            if (!chat) return;
            
            const dataStr = JSON.stringify(chat, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const fileName = `chat_${chat.name}_${new Date().toISOString().slice(0,10)}.json`;
            
            const link = document.createElement('a');
            link.href = dataUri;
            link.download = fileName;
            link.click();
            
            showNotification('üìã Chat exported as JSON');
        }
        
        function exportChatAsText(chatId) {
            const chat = projects.find(p => p.id === chatId);
            if (!chat) return;
            
            let text = `CHAT: ${chat.name}\n`;
            text += `Created: ${new Date(chat.created).toLocaleString()}\n`;
            text += `Messages: ${chat.messages.length}\n`;
            text += `${'='.repeat(50)}\n\n`;
            
            chat.messages.forEach(msg => {
                text += `[${new Date(msg.timestamp).toLocaleString()}] ${msg.role.toUpperCase()}\n`;
                text += `${msg.content}\n`;
                text += `${'-'.repeat(30)}\n\n`;
            });
            
            const dataUri = 'data:text/plain;charset=utf-8,'+ encodeURIComponent(text);
            const fileName = `chat_${chat.name}_${new Date().toISOString().slice(0,10)}.txt`;
            
            const link = document.createElement('a');
            link.href = dataUri;
            link.download = fileName;
            link.click();
            
            showNotification('üìÑ Chat exported as text');
        }
        
        function pinChat(chatId) {
            const chat = projects.find(p => p.id === chatId);
            if (!chat) return;
            
            chat.pinned = !chat.pinned;
            
            projects.sort((a, b) => {
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;
                return 0;
            });
            
            saveProjects();
            renderChatList();
            showNotification(chat.pinned ? 'üìå Chat pinned' : 'üìç Chat unpinned');
        }
        
        function duplicateChat(chatId) {
            const chat = projects.find(p => p.id === chatId);
            if (!chat) return;
            
            const newId = 'chat_' + Date.now();
            const newChat = {
                id: newId,
                name: chat.name + ' (copy)',
                messages: [...chat.messages.map(m => ({...m, id: 'copy_' + Date.now() + '_' + Math.random() }))],
                archived: false,
                pinned: false,
                created: new Date().toISOString()
            };
            
            projects.push(newChat);
            saveProjects();
            renderChatList();
            showNotification('üìë Chat duplicated');
        }
        
        function viewChatStats(chatId) {
            const chat = projects.find(p => p.id === chatId);
            if (!chat) return;
            
            const userMsgs = chat.messages.filter(m => m.role === 'user').length;
            const aiMsgs = chat.messages.filter(m => m.role === 'ai').length;
            const totalChars = chat.messages.reduce((sum, m) => sum + m.content.length, 0);
            const avgLength = Math.round(totalChars / chat.messages.length) || 0;
            
            let dateInfo = 'Unknown';
            try {
                if (chat.created) {
                    const d = new Date(chat.created);
                    if (!isNaN(d.getTime())) {
                        dateInfo = d.toLocaleString();
                    }
                }
            } catch (e) {}
            
            alert(`üìä Statistics for "${chat.name}"

Messages: ${chat.messages.length}
‚Ä¢ User: ${userMsgs}
‚Ä¢ AI: ${aiMsgs}

Content:
‚Ä¢ Total characters: ${totalChars}
‚Ä¢ Avg length: ${avgLength}

Created: ${dateInfo}
${chat.pinned ? 'üìå Pinned' : ''}`);
        }
        
        function deleteChat(chatId) {
            const id = chatId || currentChat;
            const nonArchived = projects.filter(p => !p.archived);
            if (nonArchived.length <= 1) {
                alert('Cannot delete the last chat');
                return;
            }
            
            if (confirm('Delete this chat?')) {
                projects = projects.filter(p => p.id !== id);
                currentChat = projects[0].id;
                const chat = projects.find(p => p.id === currentChat);
                document.getElementById('current-chat').textContent = chat ? chat.name : 'Chat';
                saveProjects();
                renderChatList();
                renderMessages();
                showNotification('üóëÔ∏è Chat deleted');
            }
        }
        
        function showArchivedChats() {
            const archived = projects.filter(p => p.archived);
            
            if (archived.length === 0) {
                alert('No archived chats');
                return;
            }
            
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.background = 'rgba(0,0,0,0.5)';
            overlay.style.zIndex = '10000';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            
            const modal = document.createElement('div');
            modal.style.background = 'var(--bg-secondary)';
            modal.style.borderRadius = '12px';
            modal.style.padding = '25px';
            modal.style.width = '600px';
            modal.style.maxWidth = '90%';
            modal.style.maxHeight = '80vh';
            modal.style.overflowY = 'auto';
            modal.style.border = '1px solid var(--border)';
            
            modal.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border);">
                    <h2 style="color: var(--accent); margin: 0;">üì¶ Archived Chats</h2>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; color: var(--text-secondary); font-size: 1.5em; cursor: pointer;">‚úï</button>
                </div>
                <div id="archived-list"></div>
            `;
            
            const listDiv = modal.querySelector('#archived-list');
            
            archived.forEach(chat => {
                let dateDisplay = 'Unknown date';
                try {
                    if (chat.created) {
                        const d = new Date(chat.created);
                        if (!isNaN(d.getTime())) {
                            dateDisplay = d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
                        }
                    }
                } catch (e) {}
                
                const item = document.createElement('div');
                item.style.background = 'var(--bg-tertiary)';
                item.style.borderRadius = '8px';
                item.style.padding = '15px';
                item.style.marginBottom = '10px';
                item.style.border = '1px solid var(--border)';
                
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="font-weight: bold; color: var(--accent);">${chat.name}</div>
                        <div style="font-size: 0.8em; color: var(--text-secondary);">${chat.messages.length} messages</div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                        <span style="background: var(--bg-secondary); padding: 3px 10px; border-radius: 12px; font-size: 0.8em;">üìÖ ${dateDisplay}</span>
                        <span style="background: var(--bg-secondary); padding: 3px 10px; border-radius: 12px; font-size: 0.8em;">üìù Last: ${chat.messages.length > 0 ? new Date(chat.messages[chat.messages.length-1].timestamp).toLocaleDateString() : 'No messages'}</span>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                        <button class="archive-modal-btn" data-chat-id="${chat.id}" data-action="restore" style="flex: 1; padding: 8px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer;">‚Ü©Ô∏è Restore</button>
                        <button class="archive-modal-btn" data-chat-id="${chat.id}" data-action="view" style="flex: 1; padding: 8px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">üëÅÔ∏è View</button>
                        <button class="archive-modal-btn" data-chat-id="${chat.id}" data-action="delete" style="flex: 0.5; padding: 8px; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer;">üóëÔ∏è</button>
                    </div>
                `;
                
                listDiv.appendChild(item);
            });
            
            const actionBar = document.createElement('div');
            actionBar.style.display = 'flex';
            actionBar.style.gap = '10px';
            actionBar.style.marginTop = '20px';
            
            const restoreAllBtn = document.createElement('button');
            restoreAllBtn.textContent = '‚Ü©Ô∏è Restore All';
            restoreAllBtn.style.flex = '1';
            restoreAllBtn.style.padding = '10px';
            restoreAllBtn.style.background = 'var(--accent)';
            restoreAllBtn.style.color = 'white';
            restoreAllBtn.style.border = 'none';
            restoreAllBtn.style.borderRadius = '4px';
            restoreAllBtn.style.cursor = 'pointer';
            restoreAllBtn.onclick = () => {
                if (confirm(`Restore all ${archived.length} archived chats?`)) {
                    projects.forEach(p => { if (p.archived) p.archived = false; });
                    saveProjects();
                    renderChatList();
                    overlay.remove();
                    showNotification(`‚úÖ Restored ${archived.length} chats`);
                }
            };
            
            const deleteAllBtn = document.createElement('button');
            deleteAllBtn.textContent = 'üóëÔ∏è Delete All';
            deleteAllBtn.style.flex = '1';
            deleteAllBtn.style.padding = '10px';
            deleteAllBtn.style.background = 'var(--danger)';
            deleteAllBtn.style.color = 'white';
            deleteAllBtn.style.border = 'none';
            deleteAllBtn.style.borderRadius = '4px';
            deleteAllBtn.style.cursor = 'pointer';
            deleteAllBtn.onclick = () => {
                if (confirm(`Permanently delete ALL ${archived.length} archived chats?`)) {
                    projects = projects.filter(p => !p.archived);
                    saveProjects();
                    renderChatList();
                    overlay.remove();
                    showNotification(`üóëÔ∏è Deleted ${archived.length} chats`);
                }
            };
            
            actionBar.appendChild(restoreAllBtn);
            actionBar.appendChild(deleteAllBtn);
            modal.appendChild(actionBar);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            setTimeout(() => {
                document.querySelectorAll('.archive-modal-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const chatId = this.dataset.chatId;
                        const action = this.dataset.action;
                        const chat = projects.find(p => p.id === chatId);
                        
                        if (!chat) return;
                        
                        if (action === 'restore') {
                            chat.archived = false;
                            saveProjects();
                            renderChatList();
                            overlay.remove();
                            showNotification(`‚Ü©Ô∏è Restored "${chat.name}"`);
                        } else if (action === 'view') {
                            currentChat = chatId;
                            renderMessages();
                            document.getElementById('current-chat').textContent = chat.name;
                            overlay.remove();
                            showNotification(`üëÅÔ∏è Viewing archived chat "${chat.name}"`);
                        } else if (action === 'delete') {
                            if (confirm(`Delete "${chat.name}"?`)) {
                                projects = projects.filter(p => p.id !== chatId);
                                saveProjects();
                                renderChatList();
                                overlay.remove();
                                showNotification(`üóëÔ∏è Deleted "${chat.name}"`);
                            }
                        }
                    });
                });
            }, 100);
        }
        
        function renderMessages() {
            const chat = projects.find(p => p.id === currentChat);
            if (!chat) return;
            
            const container = document.getElementById('messages');
            container.innerHTML = chat.messages.map(m => `
                <div class="message ${m.role}" data-id="${m.id}">
                    <div>${m.content.replace(/\n/g, '<br>')}</div>
                    <div class="message-footer">
                        <span>${new Date(m.timestamp).toLocaleTimeString()}</span>
                        <button class="continue-thread-btn" onclick="continueFromMessage('${m.id}')">‚Ü™Ô∏è Continue</button>
                    </div>
                </div>
            `).join('');
            container.scrollTop = container.scrollHeight;
        }
        
        function continueFromMessage(messageId) {
            const chat = projects.find(p => p.id === currentChat);
            if (!chat) return;
            
            const message = chat.messages.find(m => m.id === messageId);
            if (!message) return;
            
            const newId = 'chat_' + Date.now();
            projects.push({
                id: newId,
                name: chat.name + ' (thread)',
                messages: [{
                    id: 'thread_' + Date.now(),
                    role: 'ai',
                    content: `‚Ü™Ô∏è Continuing from: "${message.content.substring(0,100)}..."\n\nHow would you like to proceed?`,
                    timestamp: new Date().toISOString()
                }],
                archived: false,
                pinned: false,
                created: new Date().toISOString()
            });
            
            currentChat = newId;
            document.getElementById('current-chat').textContent = chat.name + ' (thread)';
            saveProjects();
            renderChatList();
            renderMessages();
            showNotification('‚Ü™Ô∏è New thread created');
        }
        
        // ==================== TOOLS PANEL ====================
        function initializeToolsPanel() {
            const panel = document.getElementById('tools-panel');
            if (!panel) return;
            
            panel.innerHTML = `
                <div class="tools-section">
                    <div class="tools-title">üåê INTERNET</div>
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span>Mode:</span>
                        <button onclick="toggleInternet()" style="padding: 5px 15px; background: ${internetEnabled ? 'var(--success)' : 'var(--bg-tertiary)'}; color: ${internetEnabled ? 'white' : 'var(--text-primary)'}; border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">
                            ${internetEnabled ? 'üåê Online' : 'üì° Offline'}
                        </button>
                    </div>
                    <div class="tool-grid">
                        <button class="tool-btn" onclick="webSearch()">üîç Web Search</button>
                        <button class="tool-btn" onclick="researchTopic()">üìö Research</button>
                    </div>
                </div>
                
                <div class="tools-section">
                    <div class="tools-title">üé® IMAGES</div>
                    <div class="tool-grid">
                        <button class="tool-btn" onclick="quickImage()">‚ö° Quick Image</button>
                        <button class="tool-btn" onclick="createImage()">üé® Create</button>
                        <button class="tool-btn" onclick="editImage()">‚úèÔ∏è Edit</button>
                        <button class="tool-btn" onclick="variations()">üîÑ Variations</button>
                    </div>
                </div>
                
                <div class="tools-section">
                    <div class="tools-title">üé¨ VIDEOS</div>
                    <div class="tool-grid">
                        <button class="tool-btn" onclick="generateVideoFromText()">üìù Text to Video</button>
                        <button class="tool-btn" onclick="generateVideoFromImage()">üñºÔ∏è Image to Video</button>
                    </div>
                    <div style="margin-top: 10px;">
                        ${Object.entries(videoStyles).map(([key, style]) => 
                            `<span class="style-preset" onclick="createVideoWithStyle('${key}')">${style.name}</span>`
                        ).join('')}
                    </div>
                </div>
                
                <div class="tools-section">
                    <div class="tools-title">üíª CODE</div>
                    <div class="tool-grid">
                        <button class="tool-btn" onclick="writeCode()">‚úçÔ∏è Write</button>
                        <button class="tool-btn" onclick="reviewCode()">üîç Review</button>
                        <button class="tool-btn" onclick="testCode()">üß™ Test</button>
                        <button class="tool-btn" onclick="debugCode()">üêõ Debug</button>
                    </div>
                </div>
                
                <div class="tools-section">
                    <div class="tools-title">üìä DATA</div>
                    <div class="tool-grid">
                        <button class="tool-btn" onclick="analyzeData()">üìà Analyze</button>
                        <button class="tool-btn" onclick="createChart()">üìä Chart</button>
                        <button class="tool-btn" onclick="financialAnalysis()">üí∞ Financial</button>
                    </div>
                </div>
                
                <div class="tools-section">
                    <div class="tools-title">üìù CONTENT</div>
                    <div class="tool-grid">
                        <button class="tool-btn" onclick="productDescription()">üì¶ Product</button>
                        <button class="tool-btn" onclick="advertGenerator()">üì¢ Advert</button>
                        <button class="tool-btn" onclick="socialPost()">üì± Social</button>
                        <button class="tool-btn" onclick="blogPost()">üìù Blog</button>
                    </div>
                </div>
                
                <div class="tools-section">
                    <div class="tools-title">üì± SOCIAL</div>
                    <div class="tool-grid">
                        <button class="tool-btn" onclick="scrapeTrends()">üìä Trends</button>
                        <button class="tool-btn" onclick="scheduleSocialPosts()">üìÖ Schedule</button>
                    </div>
                    <div style="margin-top: 10px;">
                        ${Object.entries(socialPlatforms).map(([key, platform]) => `
                            <span class="platform-badge" onclick="connectSocialAccount('${key}')">
                                <span class="status-indicator ${socialAccounts[key].connected ? 'status-connected' : 'status-disconnected'}"></span>
                                ${platform.icon} ${platform.name}
                            </span>
                        `).join('')}
                    </div>
                </div>
                
                <div class="tools-section">
                    <div class="tools-title">üåê TRANSLATE</div>
                    <div class="tool-grid">
                        <button class="tool-btn" onclick="translateText()">üìù Text</button>
                        <button class="tool-btn" onclick="translateAudio()">üé§ Audio</button>
                    </div>
                </div>
                
                <div class="tools-section">
                    <div class="tools-title">üìö DEVELOPMENT</div>
                    <div class="tool-grid">
                        <button class="tool-btn" onclick="bookSummary()">üìñ Books</button>
                        <button class="tool-btn" onclick="learningPath()">üó∫Ô∏è Learning</button>
                        <button class="tool-btn" onclick="careerAdvice()">üíº Career</button>
                    </div>
                </div>
                
                <!-- ADMIN KILL SWITCH SECTION -->
                ${currentUserRole === 'admin' ? `
                <div class="tools-section" style="border-color: var(--danger);">
                    <div class="tools-title" style="color: var(--danger);">üö® EMERGENCY CONTROLS</div>
                    <div class="action-buttons">
                        <button class="action-btn danger" onclick="emergencyPause()" style="border-color: var(--danger);">‚è∏Ô∏è PAUSE EVOLUTION (Admin only)</button>
                        <button class="action-btn danger" onclick="emergencyKill()" style="border-color: var(--danger);">‚õî KILL SYSTEM (Admin only)</button>
                    </div>
                </div>
                ` : ''}
                
                <div class="tools-section">
                    <div class="tools-title">üí° SUGGEST</div>
                    <div class="suggestion-box">
                        <textarea id="suggestion-input" placeholder="How can DMAI evolve? (Your suggestions guide evolution)"></textarea>
                        <button class="suggestion-btn" onclick="submitSuggestion()">Submit to Evolution Engine</button>
                    </div>
                </div>
                
                <div class="info-box">
                    <div class="tools-title">üåê ACCESS</div>
                    <div class="info-row">
                        <span class="url-display" id="cloud-url">https://dmai.onrender.com</span>
                        <button class="copy-btn" onclick="copyUrl()">Copy</button>
                    </div>
                </div>
            `;
        }
        
        // ==================== TOOL FUNCTIONS ====================
        function webSearch() {
            if (!internetEnabled) {
                alert('Please enable Internet mode first');
                return;
            }
            addAIMessage('üîç Web Search', 'What would you like me to search for?');
        }
        
        function researchTopic() {
            if (!internetEnabled) {
                alert('Please enable Internet mode first');
                return;
            }
            addAIMessage('üìö Research', 'What topic would you like me to research?');
        }
        
        function quickImage() {
            addAIMessage('üé® Quick Image', handleImageGeneration('a beautiful landscape'));
        }
        
        function createImage() {
            addAIMessage('üé® Image Creation', 'Please describe what image you\'d like me to create. Example: "a cat" or "photorealistic mountain sunset"');
        }
        
        function editImage() {
            addAIMessage('‚úèÔ∏è Image Editing', 'Tell me what you\'d like to edit in the last image. Example: "Make it brighter" or "Change the background"');
        }
        
        function variations() {
            addAIMessage('üîÑ Variations', 'I\'ll create variations of the last image. What style would you like to see?');
        }
        
        function generateVideoFromText() {
            addAIMessage('üé¨ Text to Video', 'Please describe the video you want to create. Include style, duration, and scene details.');
        }
        
        function generateVideoFromImage() {
            addAIMessage('üé¨ Image to Video', 'I\'ll animate your last image. Tell me what movement you want.');
        }
        
        function createVideoWithStyle(style) {
            const styleInfo = videoStyles[style] || videoStyles.manga;
            addAIMessage('üé¨ Video Generation', `Creating a ${styleInfo.name} style video. Please describe what you want to see.`);
        }
        
        function writeCode() {
            addAIMessage('üíª Code Writing', 'Tell me what code you need. Include language and requirements.');
        }
        
        function reviewCode() {
            addAIMessage('üîç Code Review', 'Please paste the code you want me to review.');
        }
        
        function testCode() {
            addAIMessage('üß™ Code Testing', 'Please provide the code and test cases.');
        }
        
        function debugCode() {
            addAIMessage('üêõ Debug Code', 'Please paste the code and describe the issue.');
        }
        
        function analyzeData() {
            addAIMessage('üìä Data Analysis', 'Please provide the data you want me to analyze.');
        }
        
        function createChart() {
            addAIMessage('üìä Create Chart', 'Please provide the data and chart type (bar, line, pie).');
        }
        
        function financialAnalysis() {
            addAIMessage('üí∞ Financial Analysis', 'Please provide stock tickers or financial data.');
        }
        
        function productDescription() {
            addAIMessage('üì¶ Product Description', 'Tell me about your product and I\'ll write a description.');
        }
        
        function advertGenerator() {
            addAIMessage('üì¢ Advert Generator', 'Tell me about your product and target audience.');
        }
        
        function socialPost() {
            addAIMessage('üì± Social Post', 'What platform and what would you like to post?');
        }
        
        function blogPost() {
            addAIMessage('üìù Blog Post', 'What topic should I write about?');
        }
        
        function scrapeTrends() {
            if (!internetEnabled) {
                alert('Please enable Internet mode first');
                return;
            }
            addAIMessage('üìä Trend Analysis', 'Analyzing current social media trends...\n\nTop trends:\n‚Ä¢ #AIRevolution\n‚Ä¢ #VideoGeneration\n‚Ä¢ #TechNews\n\nCreate content for any of these?');
        }
        
        function scheduleSocialPosts() {
            addAIMessage('üìÖ Schedule', 'I can help schedule your posts. Best times:\n‚Ä¢ TikTok: 7 AM, 7 PM\n‚Ä¢ Instagram: 8 AM, 6 PM\n‚Ä¢ YouTube: 11 AM, 4 PM');
        }
        
        function connectSocialAccount(platform) {
            const name = prompt(`Enter your ${socialPlatforms[platform].name} username:`);
            if (name) {
                socialAccounts[platform].connected = true;
                if (platform === 'youtube') socialAccounts[platform].channelName = name;
                else if (platform === 'twitter') socialAccounts[platform].handle = name;
                else socialAccounts[platform].username = name;
                
                initializeToolsPanel();
                showNotification(`‚úÖ Connected to ${socialPlatforms[platform].name}`);
            }
        }
        
        function translateText() {
            addAIMessage('üåê Translation', 'What text would you like translated and to which language?');
        }
        
        function translateAudio() {
            addAIMessage('üé§ Audio Translation', 'Please upload an audio file and specify target language.');
        }
        
        function bookSummary() {
            addAIMessage('üìñ Book Summary', 'Which book would you like summarized?');
        }
        
        function learningPath() {
            addAIMessage('üó∫Ô∏è Learning Path', 'What skill would you like to learn?');
        }
        
        function careerAdvice() {
            addAIMessage('üíº Career Advice', 'Tell me about your career goals and I\'ll provide guidance.');
        }
        
        function addAIMessage(title, content) {
            const chat = projects.find(p => p.id === currentChat);
            if (!chat) return;
            
            chat.messages.push({
                id: 'tool_' + Date.now(),
                role: 'ai',
                content: `**${title}**\n\n${content}`,
                timestamp: new Date().toISOString()
            });
            
            saveProjects();
            renderMessages();
        }
        
        function handleImageGeneration(prompt) {
            let subject = prompt.replace(/image|picture|photo|create|generate|of|a|an|the/gi, '').trim() || 'this scene';
            
            return `**Image Generation**\n\nBased on "${subject}", I've created options:\n\n` +
                   `**Option 1: Photorealistic**\n` +
                   `![Generated 1](https://placekitten.com/400/300?image=1)\n\n` +
                   `**Option 2: Anime Style**\n` +
                   `![Generated 2](https://placekitten.com/401/300?image=2)\n\n` +
                   `**Which style do you prefer?** Tell me and I'll refine it!`;
        }
        
        function sendMessage() {
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            if (!content) return;
            
            const chat = projects.find(p => p.id === currentChat);
            if (!chat) return;
            
            chat.messages.push({
                id: 'msg_' + Date.now(),
                role: 'user',
                content: content,
                timestamp: new Date().toISOString()
            });
            
            // Check if this is guidance for evolution
            if (content.toLowerCase().includes('evolve') || 
                content.toLowerCase().includes('improve') ||
                content.toLowerCase().includes('make better')) {
                submitGuidanceToEngine(content);
            }
            
            let response = '';
            const lower = content.toLowerCase();
            
            if (lower.includes('cat') || lower.includes('image') || lower.includes('picture')) {
                response = handleImageGeneration(content);
            } else if (lower.includes('video') || lower.includes('animate')) {
                response = `üé¨ **Video Generation**\n\nI'll create a video based on "${content}".\n\nWhat style? (manga, photorealistic, cyberpunk)`;
            } else if (lower.includes('code') || lower.includes('program')) {
                response = `üíª **Code**\n\nHere's an example:\n\`\`\`python\nprint("Hello World")\n\`\`\`\n\nNeed something specific?`;
            } else if (lower.includes('research') || lower.includes('search')) {
                response = `üîç **Research**\n\nI'll help research "${content}". ${internetEnabled ? 'üåê Searching...' : 'Enable internet for live search.'}`;
            } else {
                response = `üß† **Response**\n\nI understand: "${content.substring(0,50)}..."\n\nHow can I help further?`;
            }
            
            chat.messages.push({
                id: 'resp_' + Date.now(),
                role: 'ai',
                content: response,
                timestamp: new Date().toISOString()
            });
            
            input.value = '';
            saveProjects();
            renderMessages();
        }
        
        function submitSuggestion() {
            const input = document.getElementById('suggestion-input');
            if (!input) return;
            
            const suggestion = input.value.trim();
            if (!suggestion) return;
            
            const chat = projects.find(p => p.id === currentChat);
            if (!chat) return;
            
            submitGuidanceToEngine(suggestion);
            
            chat.messages.push({
                id: 'sugg_' + Date.now(),
                role: 'ai',
                content: `üåü **Suggestion Received**\n\nThank you for: "${suggestion}"\n\nThis has been sent to the 24/7 evolution engine and will influence cycle ${evolutionData.generation + 1}!`,
                timestamp: new Date().toISOString()
            });
            
            input.value = '';
            saveProjects();
            renderMessages();
            showNotification('üí° Suggestion sent to evolution engine');
        }
        
        function copyUrl() {
            const url = 'https://dmai.onrender.com';
            navigator.clipboard.writeText(url);
            showNotification('‚úÖ URL copied');
        }
        
        // Initialize
        loadUsers();
        
        // Check auto-login
        if (!checkAutoLogin()) {
            // Show login screen if not auto-logged in
            document.getElementById('login-screen').style.display = 'flex';
        }
        
        document.getElementById('message-input')?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Initial fetch of evolution stats
        setTimeout(fetchEvolutionStats, 1000);
    </script>
</body>
</html>
